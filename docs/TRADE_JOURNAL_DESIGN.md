# 매매일지 설계 (Trade Journal Design)

## 1. 목적
매매일지는 단순한 거래 기록이 아니라, **시스템 규칙의 준수 여부를 사후 검증**하고 전략의 개선점을 도출하기 위한 핵심 도구입니다. 모든 항목은 자동 기록을 원칙으로 하되, 규칙 준수 체크와 회고는 매매 종료 시점에 사람이 직접 작성합니다.

## 2. 일지 구조

### [가] 기본 정보 (Basic Info)
매매의 사실 관계를 기록합니다. 시스템이 자동으로 채웁니다.

| 항목 | 설명 | 예시 |
|---|---|---|
| `trade_id` | 고유 매매 식별자 | `T-20260226-001` |
| `symbol` | 거래 종목 | `BTCUSDT` |
| `direction` | 매매 방향 | `LONG` / `SHORT` |
| `entry_time` | 최초 진입 시각 (UTC) | `2026-02-26T05:00:00Z` |
| `entry_price` | 최초 진입가 | `87,500` |
| `exit_time` | 청산 시각 (UTC) | `2026-03-01T12:30:00Z` |
| `exit_price` | 청산가 | `92,100` |
| `position_size` | 총 포지션 크기 (유닛 수 × 유닛 사이즈) | `0.4 BTC (4 units)` |
| `pnl` | 실현 손익 (USDT) | `+1,840 USDT` |
| `pnl_percent` | 계좌 대비 수익률 | `+1.84%` |
| `fees` | 총 수수료 | `12.5 USDT` |
| `holding_period` | 보유 기간 | `3d 7h 30m` |

### [나] 전략 기록 (Strategy Record)
터틀 시스템의 어떤 규칙에 의해 매매가 발생했는지 기록합니다.

| 항목 | 설명 | 예시 |
|---|---|---|
| `system` | 진입 시스템 | `S1` / `S2` |
| `entry_trigger` | 진입 조건 | `20일 고가 돌파 (dc_20_high: 87,200)` |
| `exit_trigger` | 청산 조건 | `10일 저가 이탈 (dc_10_low: 92,050)` |
| `n_at_entry` | 진입 시점의 $N$ 값 | `1,250` |
| `unit_size` | 1유닛 크기 | `0.1 BTC` |
| `units_added` | 피라미딩 횟수 | `3회 (진입가: 87500, 88125, 88750, 89375)` |
| `max_units` | 최대 보유 유닛 | `4 / 4` |
| `stop_loss_level` | 최종 손절가 ($2N$) | `86,875` |
| `ema_200_at_entry` | 진입 시 EMA-200 | `82,300 (가격 > EMA ✓)` |
| `volatility_cap` | 변동성 캡 적용 여부 | `미적용` / `적용 (유닛 50% 축소)` |
| `skip_rule` | S1 Skip Rule 적용 여부 | `미적용 (직전 매매: Loss)` |

### [다] 규칙 준수 체크 (Rule Compliance)
시스템의 신호와 실제 체결이 일치했는지 검증합니다.

| 항목 | 설명 | 예시 |
|---|---|---|
| `signal_followed` | 시스템 신호대로 매매했는가? | `YES` / `NO` |
| `deviation_reason` | 불일치 시 사유 | `API 오류로 진입 지연` / `수동 개입으로 조기 청산` / `-` |
| `all_pyramids_executed` | 모든 피라미딩이 실행되었는가? | `YES` / `NO (3/4, 잔고 부족)` |
| `stop_loss_honored` | 손절 규칙을 준수했는가? | `YES` / `-` |

### [라] 회고 (Post-Trade Review)
매매 종료 후 한 줄로 요약합니다. **자동화 불가, 반드시 수동 입력.**

| 항목 | 설명 | 예시 |
|---|---|---|
| `what_went_well` | 잘한 점 한 줄 | `S1 스킵 후 S2 진입으로 큰 추세를 잡았다` |
| `what_to_improve` | 개선할 점 한 줄 | `피라미딩 3번째에서 주저하여 30초 지연 진입` |

## 3. 저장 형식
- **파일**: `logs/journal/YYYY-MM.json` (월별 파일)
- **포맷**: JSON Array. 각 원소가 하나의 완결된 매매 기록.
- 회고 항목(`what_went_well`, `what_to_improve`)은 매매 종료 시 `null`로 생성되며, 사용자가 추후 채웁니다.

## 4. 자동 기록 시점
| 이벤트 | 기록 항목 |
|---|---|
| `BUY` 신호 체결 | 기본 정보(진입), 전략 기록 생성 |
| `PYRAMID` 체결 | `units_added` 업데이트 |
| `EXIT` 체결 | 기본 정보(청산), PnL 계산, 규칙 준수 자동 판정, 회고란 `null` 생성 |
